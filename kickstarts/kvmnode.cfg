# Kickstart file for automated installation

# Start of %PRE

%pre

# Identify first drive and generate additional kickstart file which is incuded afterwards
DISK=$(lsblk -ndo NAME,TYPE | grep disk | grep -v ram | head -n1 | awk '{print "/dev/"$1}')
echo "bootloader --location=mbr --boot-drive=$DISK" > /tmp/bootloader-ks.cfg
echo "KICKSTART: Detected disk drive $DISK"

# Detect the first network interface with a connected link
INTERFACE=$(ip -o link show | awk -F': ' '/state UP/ {print $2}' | head -n1)
echo "KICKSTART: Detected network interface name $INTERFACE"

# Fallback: Use the first available interface if none are "UP"
if [ -z "$INTERFACE" ]; then
    INTERFACE=$(ip -o link show | awk -F': ' '{print $2}' | grep -v lo | head -n1)
fi

# Get the IPv4 address assigned to that interface
# we will use it to configure SSHD to listen only on this one
IPADDR=$(ip -4 -o addr show dev "$INTERFACE" | awk '{print $4}' | cut -d/ -f1 | head -n1)
echo "KICKSTART: Detected IP address $IPADDR for interface $INTERFACE"

# Write the network configuration dynamically
echo "network --bootproto=dhcp --device=$INTERFACE --onboot=yes" > /tmp/network-ks.cfg

%end

# END of %PRE

# MAIN generic section -------------------------

DEPLOYER=10.11.12.2

# Use network installation media from deployer's local repository
url --url=http://$DEPLOYER/rocky9

# Text mode
text

# Reboot automatically after installation
reboot

# Language and Keyboard Settings
lang en_US.UTF-8
keyboard us

# Network Configuration from dynamic file
%include /tmp/network-ks.cfg
# Old ugly static entry
# network --bootproto=dhcp --device=enp1s0 --onboot=yes

# Root Password
rootpw --iscrypted $6$XP5lKlI7XkAGVNoJ$QQgrA4eEU1K1/DvkcFgTR7xajfm7/eqb6nw0YmLnRPMEr/h8D0CRJQYikZM4yQiyiF5ZrMrXm58q0isV9ZZkt/

# Disable firstboot
firstboot --disable

# Timezone
timezone Europe/Warsaw --utc

# Partitioning (automated)
# clearpart --all --initlabel
# autopart --type=lvm
# Partitioning - customized for KVM, / is minimal and rest goes to /var/lib/libvirt/images
zerombr
clearpart --all --initlabel
# ignoredisk --only-use=sda

part /boot --fstype=xfs --size=1024 --ondisk=sda
part pv.01 --size=1 --grow --ondisk=sda
volgroup rl pv.01

logvol /    --vgname=rl --name=root --fstype=xfs --size=40960
logvol swap --vgname=rl --name=swap --size=32767
logvol /var/lib/libvirt/images --vgname=rl --name=vmstore --fstype=xfs --size=1 --grow

# Bootloader Configuration
# Get the drive name from lsblk output
%include /tmp/bootloader-ks.cfg

# Legacy dumb bootloader installation method
#bootloader --location=mbr --boot-drive=vda

# Firewall configuration
firewall --enabled --service=ssh

# Package Selection
%packages
@^minimal-environment
vim
wget
net-tools
# Add additional packages or groups here
%end

# Post-installation script
%post

# make SSHD listen on first interface only
if [ -n "$IPADDR" ]; then
    echo "KICKSTART: ListenAddress $IPADDR" > /etc/ssh/sshd_config.d/99-listen.conf
else
    echo "KICKSTART: Warning - could not detect IP for $INTERFACE, sshd will listen on all addresses"
fi

# Add a user
# useradd -m -s /bin/bash remotemanagement
# echo "remotemanagement:verycomplexpassword:)" | chpasswd

# Enable SSH
systemctl enable sshd

# Set hostname that has been defined in PXE phase (DHCP server dependent)
echo "$HOSTNAME" > /etc/hostname
hostnamectl set-hostname "$HOSTNAME"

# Configure dhclient to send hostname
# it works as intended if there is a static lease in DHCP server
echo 'send host-name "$(HOSTNAME)";' >> /etc/dhcp/dhclient.conf

# Restart networking to apply the hostname
systemctl restart NetworkManager || systemctl restart network

# mount NFS volume where boot images exist
echo "mother:/home/tftpboot /mnt/tftpboot nfs defaults 0 0" >> /etc/fstab
mkdir -p /mnt/tftpboot
systemctl enable nfs-client.target

# set local repos for 10x faster deployment           
#cat <<EOF > /etc/yum.repos.d/local-repos.repo      
#[local-BaseOS]                                        
#name=Rocky9_BaseOS                                    
#baseurl=http://$DEPLOYER/repos/rocky9/BaseOS/
#gpgcheck=0                                                                               
#enabled=1                                             
#priority=1                                                                                 
                                                                            
#[local-AppStream]                                                               
#name=Rocky9_AppStream                              
#baseurl=http://$DEPLOYER/repos/rocky9/AppStream/    
#gpgcheck=0                                                                  
#enabled=1                                          
#priority=1                                                    
                                                      
#[local-Extras]                                                                    
#name=Rocky9_Extras                                 
#baseurl=http://$DEPLOYER/repos/rocky9/Extras/   
#gpgcheck=0                                             
#enabled=1                                                                             
#priority=1                                            
#EOF

yum -y update


# KVM specific (first boot - download & run via systemd oneshot "run once")

# Instead of embedding the whole bootstrap script inside Kickstart, we create a small runner that:
#  - downloads the real script from: http://$DEPLOYER/kickstarts/firstboot-kvm.sh
#  - stores it locally under /var/lib/firstboot-kvm/
#  - executes it once (and only once) on the first boot
#  - writes logs to /var/log/firstboot-kvm.log
#
# Advantages:
#  - Kickstart stays small and readable
#  - You can update the bootstrap logic on the web server without touching the installer media
#  - If download fails, the service fails and will retry on the next boot (marker isn't created)

mkdir -p /var/lib/firstboot-kvm

cat <<'EOF' > /usr/local/sbin/firstboot-kvm-runner.sh
#!/usr/bin/env bash
set -euo pipefail

URL="http://$DEPLOYER/kickstarts/firstboot-kvm.sh"
WORKDIR="/var/lib/firstboot-kvm"
SCRIPT="${WORKDIR}/firstboot-kvm.sh"
MARKER="/var/lib/firstboot-kvm.done"
LOG="/var/log/firstboot-kvm.log"

exec > >(tee -a "$LOG") 2>&1

echo "=== firstboot-kvm runner: start $(date -Is) ==="

if [[ -f "$MARKER" ]]; then
  echo "Marker exists ($MARKER). Nothing to do."
  exit 0
fi

mkdir -p "$WORKDIR"

TMP="$(mktemp "${WORKDIR}/.firstboot-kvm.XXXXXX")"

echo "Downloading bootstrap script: $URL"
# wget is included in %packages in this kickstart; add curl if you prefer.
# Retry logic makes flaky DHCP/DNS on first boot less painful.
/usr/bin/wget -q --timeout=20 --tries=10 --waitretry=5 -O "$TMP" "$URL"

# Basic sanity check: downloaded file should start with a shebang
head -n1 "$TMP" | grep -q '^#!' || { echo "Downloaded file doesn't look like a script (missing shebang)."; rm -f "$TMP"; exit 1; }

chmod 0700 "$TMP"
mv -f "$TMP" "$SCRIPT"

echo "Executing: $SCRIPT"
"$SCRIPT"

# Only mark done if the script finished successfully
touch "$MARKER"

echo "=== firstboot-kvm runner: done $(date -Is) ==="
EOF

chmod 0755 /usr/local/sbin/firstboot-kvm-runner.sh

cat <<'EOF' > /etc/systemd/system/firstboot-kvm.service
[Unit]
Description=KVM node bootstrap (first boot, download & run)
ConditionPathExists=!/var/lib/firstboot-kvm.done
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/sbin/firstboot-kvm-runner.sh

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable firstboot-kvm.service
%end
