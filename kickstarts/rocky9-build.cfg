# Rocky Linux 9 - Golden Image Kickstart for CloudStack (KVM)
# Disk: vda (virtio)
# Install source: local HTTP repo
# Purpose: generic template (cloud-init + qemu-guest-agent enabled, no lab-specific config)

# -------------------------
# CONFIG YOU MUST SET
# -------------------------
# Example:
# url --url=http://deployer01/rocky9
#
# Your repo should expose BaseOS/AppStream in the standard way for Anaconda.
# If you're mirroring the full tree, pointing at the top-level is usually correct.
export DEPLOYER=mother.home.lab
url --url=http://$DEPLOYER/rocky9

text
reboot

lang en_US.UTF-8
keyboard us
timezone Europe/Warsaw --utc

# -------------------------
# %PRE: detect NIC (DHCP)
# -------------------------
%pre --log=/tmp/ks-pre.log
set -eux

# Detect the first network interface with link UP
INTERFACE="$(ip -o link show | awk -F': ' '/state UP/ {print $2}' | head -n1 || true)"
if [ -z "${INTERFACE}" ]; then
  INTERFACE="$(ip -o link show | awk -F': ' '{print $2}' | grep -v '^lo$' | head -n1)"
fi
echo "KICKSTART: Detected network interface: ${INTERFACE}" | tee -a /tmp/ks-pre.log

echo "network --bootproto=dhcp --device=${INTERFACE} --onboot=yes --activate" > /tmp/network-ks.cfg

# Ensure DEPLOYER variable is available to %post. Use existing value or default.
DEPLOYER="${DEPLOYER:-mother.home.lab}"
cat > /tmp/ksvars <<EOF
DEPLOYER='${DEPLOYER}'
EOF
%end

%include /tmp/network-ks.cfg

# Root password (keep your existing hash)
rootpw --iscrypted $6$XP5lKlI7XkAGVNoJ$QQgrA4eEU1K1/DvkcFgTR7xajfm7/eqb6nw0YmLnRPMEr/h8D0CRJQYikZM4yQiyiF5ZrMrXm58q0isV9ZZkt/

firstboot --disable
selinux --enforcing
firewall --enabled --service=ssh

# -------------------------
# Storage / partitioning
# -------------------------
zerombr
clearpart --all --initlabel
ignoredisk --only-use=vda

# Bootloader (explicit for vda)
bootloader --location=mbr --boot-drive=vda

# NOTE about LVM:
# This layout is OK, but auto-grow of / is easiest with non-LVM. If you want the "simplest auto-grow root",
# tell me and Iâ€™ll generate the non-LVM variant.
part /boot --fstype=xfs --size=1024 --ondisk=vda
part pv.01 --size=1 --grow --ondisk=vda
volgroup rl pv.01

logvol /    --vgname=rl --name=root --fstype=xfs --size=8192
logvol swap --vgname=rl --name=swap --size=8192

# Optional extra LV (usually NOT needed for VM templates; keep commented unless you really want it)
# logvol /var/lib/libvirt/images --vgname=rl --name=vmstore --fstype=xfs --size=1 --grow

# -------------------------
# Packages
# -------------------------
%packages
@^minimal-environment
vim
wget
net-tools

# CloudStack/KVM golden image essentials
cloud-init
qemu-guest-agent

# Helpful utilities
cloud-utils-growpart
chrony
%end

# -------------------------
# Post-install
# -------------------------
%post --log=/root/ks-post.log
set -eux

# Enable SSH
systemctl enable sshd

# Cloud-init: prefer CloudStack datasource
mkdir -p /etc/cloud/cloud.cfg.d
cat >/etc/cloud/cloud.cfg.d/99-cloudstack.cfg <<'EOF'
datasource_list: [ CloudStack, NoCloud, None ]
EOF

# Enable cloud-init + qemu guest agent + time sync
systemctl enable cloud-init
systemctl enable qemu-guest-agent
systemctl enable chronyd

# IMPORTANT:
# - do NOT set hostname here (CloudStack/cloud-init will)
# - do NOT pin sshd ListenAddress to installer IP
# - do NOT mount lab NFS shares
# - do NOT run dnf/yum update here (keep build reproducible)

# Load variables generated in %pre and record template metadata
if [ -f /tmp/ksvars ]; then
  . /tmp/ksvars
fi
mkdir -p /etc
cat >/etc/template-info <<EOF
DEPLOYER=${DEPLOYER:-unknown}
EOF

%end